@startuml
skinparam shadowing false
autonumber
title Sekwencja logowania z opcjonalnym 2FA (wymiana tokena tymczasowego)

actor User as Użytkownik
participant "SmartAuth.Web/ClientApp" as SPA
participant "SmartAuth.Api\nAuthEndpoints" as API
participant "AuthLoginCommandHandler" as LoginHandler
participant "AuthDbContext" as DB
participant "TokenUtilities" as Tokens

Użytkownik -> SPA : Wprowadza email i hasło
SPA -> API : POST /api/auth/login
API -> LoginHandler : AuthLoginCommand
LoginHandler -> DB : Users.Include(Authenticators,Biometrics)
DB --> LoginHandler : Agregat użytkownika
LoginHandler -> LoginHandler : Weryfikacja hasła + wybór metod

alt methods.Count == 0
  LoginHandler -> Tokens : IssueAccessToken(...)
  Tokens --> LoginHandler : accessJwt
  LoginHandler --> API : AuthLoginResult(false, accessJwt)
  API --> SPA : 200 requires2Fa=false, token=accessJwt
  SPA -> SPA : saveJwt(accessJwt)
else methods.Count > 0
  LoginHandler -> Tokens : IssueTempToken(...)
  Tokens --> LoginHandler : tempJwt
  LoginHandler --> API : AuthLoginResult(true, tempJwt, methods[])
  API --> SPA : 200 requires2Fa=true, token=tempJwt, methods[]

  Użytkownik -> SPA : Podaje drugi składnik
  SPA -> API : POST /api/auth/2fa/{code|face|voice}/verify\nAuthorization: Bearer tempJwt
  API -> DB : Załaduj użytkownika + referencje auth/biometria
  DB --> API : Dane do weryfikacji
  API -> Tokens : IssueAccessToken(...)
  Tokens --> API : accessJwt
  API --> SPA : 200 { jwt: accessJwt }
  SPA -> SPA : saveJwt(accessJwt)
end
@enduml
